{% extends "website/base.html" %}
{% load static %}

{% block content %}
<h1>Default Locks (Rooms & Exits)</h1>

<form method="post" id="lock-form">{% csrf_token %}
  <fieldset class="card p-3">
    <legend>Compose</legend>
    <div>
      <label>{{ form.include_creator }} Include creator id() in owner controls</label>
    </div>
    <div>
      <label>Traverse (Exits):</label>
      {{ form.traverse_choice }}
      <span id="traverse-custom-wrap" style="display:none">
        {{ form.traverse_custom }}
        <small>Example: <code>holds(key) and not perm(Banned)</code></small>
      </span>
    </div>
    <details class="mt-2">
      <summary>Composed Previews</summary>
      <div class="mono small">
        <div><strong>Room (preview):</strong> <code id="room-preview">{{ composed_room }}</code></div>
        <div><strong>Exit (preview):</strong> <code id="exit-preview">{{ composed_exit }}</code></div>
      </div>
    </details>
  </fieldset>

  <fieldset class="card p-3 mt-3">
    <legend>Raw (Advanced)</legend>
    <div>
      <label>Room default lockstring</label>
      {{ form.room_lockstring }}
      {% if room_validation %}
        <p class="{{ room_validation.0|yesno:'ok,err' }}">
          {{ room_validation.1 }}
        </p>
      {% endif %}
      <button type="button" class="btn btn-secondary" data-target="id_room_lockstring">Validate</button>
    </div>
    <div class="mt-2">
      <label>Exit default lockstring</label>
      {{ form.exit_lockstring }}
      {% if exit_validation %}
        <p class="{{ exit_validation.0|yesno:'ok,err' }}">
          {{ exit_validation.1 }}
        </p>
      {% endif %}
      <button type="button" class="btn btn-secondary" data-target="id_exit_lockstring">Validate</button>
    </div>
  </fieldset>

  <div class="mt-3">
    <button class="btn btn-primary" type="submit">Save defaults</button>
  </div>
</form>

<hr/>
<details>
  <summary>Lockstring Cheatsheet</summary>
  <ul class="small mono">
    <li><code>control|delete|edit: pid(USER_ID) or id(CHAR_ID) or perm(Admin)</code> — owner triple</li>
    <li><code>traverse: all()</code> — anyone can use exit</li>
    <li><code>traverse: perm(Builder)</code> — builders only</li>
    <li><code>traverse: holds(key)</code> — must hold object named "key"</li>
    <li><code>get:false()</code>, <code>puppet:false()</code> — disallow pickup/puppet</li>
    <li>Combine: <code>and()</code>, <code>or()</code>, <code>not()</code></li>
  </ul>
</details>

<style>
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .small { font-size: 0.9rem; }
  .ok { color: #2b8a3e; }
  .err { color: #c92a2a; }
  .card { border: 1px solid var(--border-color,#333); border-radius: 8px; }
  .p-3 { padding: 1rem; }
  .mt-2 { margin-top: .5rem; }
  .mt-3 { margin-top: 1rem; }
</style>

<script>
  const traverse = document.getElementById("id_traverse_choice");
  const customWrap = document.getElementById("traverse-custom-wrap");
  const form = document.getElementById("lock-form");

  function toggleCustom() {
    customWrap.style.display = (traverse.value === "expr") ? "inline-block" : "none";
  }
  traverse.addEventListener("change", toggleCustom);
  toggleCustom();

  document.querySelectorAll('button[data-target]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.getAttribute('data-target');
      const ta = document.getElementById(id);
      const data = new URLSearchParams();
      data.append('lockstring', ta.value);
      data.append('csrfmiddlewaretoken', document.querySelector('input[name=csrfmiddlewaretoken]').value);
      const res = await fetch("{% url 'roomeditor:locks_validate' %}", { method: 'POST', body: data });
      const json = await res.json();
      const msg = document.createElement('p');
      msg.className = json.ok ? 'ok' : 'err';
      msg.textContent = json.message;
      ta.parentElement.appendChild(msg);
      setTimeout(() => msg.remove(), 5000);
    });
  });
</script>
{% endblock %}
